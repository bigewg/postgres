4 ВМ  
dz14_1  158.160.12.12   БД dz14_1  
dz14_2  158.160.31.17   БД dz14_2  
dz14_3  84.201.143.17   БД dz14_3  
dz14_4  158.160.30.116  БД dz14_4  

1. Создаем виртуалку (2CPU 2Gb) и устанавливаем постгрес 15.    
```
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
```

2. Создаем, БД, таблицы, публикацию,  меняем режим журналрования и рестартуем кластер. Аналогичные объекты создаем и на 2-ом кластере:  
``` 
bigewg@dz14-1:~$ sudo -u  postgres -i 
postgres@dz14-1:~$ psql
postgres=# ALTER SYSTEM SET wal_level = logical;
postgres=# create database dz14_1;
postgres=# \c dz14_1
dz14_1=# create table test1 as 
         select generate_series(1,10) as id, 'test1' as fio;
dz14_1=# create table test2 (id integer, fio  varchar);
dz14_1=# CREATE PUBLICATION test1_pub FOR TABLE test1;
postgres=# exit
postgres@dz14-1:~$pg_ctlcluster 15 main restart
```

3. Открываем удаленный доступ в наш кдастер:  
```
postgres@dz14-1:~$ vi /etc/postgresql/15/main/pg_hba.conf
host    replication     postgres        0.0.0.0/0               scram-sha-256
postgres@dz14-1:~$ vi /etc/postgresql/15/main/postgresql.conf 
listen_addresses = '*'            # what IP address(es) to listen on;
```
4. Создаем подписку:  
```
dz14_1=# CREATE SUBSCRIPTION test2_sub 
CONNECTION 'host=158.160.31.17 port=5432 user=postgres password=qwe123 dbname=dz14_2' 
PUBLICATION test2_pub WITH (copy_data = true);
```

5. Создаем 3ВМ с 15 постгресом. Открываем на ней удаленный доступ. Создаем в кластере бд dz14_3.  Создаем там 2 пустых таблицы для подписок и сами подписки.
```
postgres=# \c dz14_3
dz14_3=# create table test1 (id integer, fio varchar);
dz14_3=# create table test2 (id integer, fio varchar);
dz14_3=# CREATE SUBSCRIPTION test2_sub3 
CONNECTION 'host=158.160.31.17 port=5432 user=postgres password=qwe123 dbname=dz14_2' 
PUBLICATION test2_pub WITH (copy_data = true);
NOTICE:  created replication slot "test2_sub3" on publisher
CREATE SUBSCRIPTION
dz14_3=# CREATE SUBSCRIPTION test1_sub3 
CONNECTION 'host=158.160.12.12 port=5432 user=postgres password=qwe123 dbname=dz14_1' 
PUBLICATION test1_pub WITH (copy_data = true);
NOTICE:  created replication slot "test1_sub3" on publisher
CREATE SUBSCRIPTION
```

6.  Создаем 3ВМ с 15 постгресом. Открываем на ней удаленный доступ. Останавливаем кластер и зачищаем старые файлы.
```
postgres@dz14-4:~$ pg_ctlcluster 15 main stop
postgres@dz14-4:~$ mv /var/lib/postgresql/15/main /var/lib/postgresql/15/main_bc
```
7. Копируем БД одновременно запуская процесс репликации. Проверяем, что параметр репликации включен.
```
postgres@dz14-4:~$ pg_basebackup -h 84.201.143.17 -p 5432 -R -D /var/lib/postgresql/15/main
postgres@dz14-4:~$ pg_ctlcluster 15 main start
postgres=# show hot_standby;
 hot_standby 
-------------
 on

postgres=# \l
                                                 List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges   
-----------+----------+----------+-------------+-------------+------------+-----------------+-----------------------
 dz14_3    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | 
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | 
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres

postgres=# \c dz14_3
You are now connected to database "dz14_3" as user "postgres".
dz14_3=# \dt
         List of relations
 Schema | Name  | Type  |  Owner   
--------+-------+-------+----------
 public | test1 | table | postgres
 public | test2 | table | postgres
```

Вопрос про настройку удаленного доступа.
вопрос про параллельность бекапа.



