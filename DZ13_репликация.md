0. Создаем 4 виртуалные машины (2CPU 2Gb) и устанавливаем на них постгрес 15.  
```    
dz14_1  158.160.12.12   БД dz14_1  
dz14_2  158.160.31.17   БД dz14_2  
dz14_3  84.201.143.17   БД dz14_3  
dz14_4  158.160.30.116     
```      
```
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
```

1. Cоздаем, БД, таблицы, публикацию,  меняем режим журналрования и рестартуем кластер. Аналогичные объекты создаем и на 2-ом кластере:  
``` 
bigewg@dz14-1:~$ sudo -u  postgres -i 
postgres@dz14-1:~$ psql
postgres=# ALTER SYSTEM SET wal_level = logical;
postgres=# create database dz14_1;
postgres=# \c dz14_1
dz14_1=# create table test1 as 
         select generate_series(1,10) as id, 'test1' as fio;
dz14_1=# create table test2 (id integer, fio  varchar);
dz14_1=# CREATE PUBLICATION test1_pub FOR TABLE test1;
postgres=# exit
postgres@dz14-1:~$pg_ctlcluster 15 main restart
```

Открываем удаленный доступ в наш кдастер:  
```
postgres@dz14-1:~$ vi /etc/postgresql/15/main/pg_hba.conf
host    replication     postgres        0.0.0.0/0               scram-sha-256
postgres@dz14-1:~$ vi /etc/postgresql/15/main/postgresql.conf 
listen_addresses = '*'            # what IP address(es) to listen on;
```
Создаем подписку:  
```
dz14_1=# CREATE SUBSCRIPTION test2_sub 
CONNECTION 'host=158.160.31.17 port=5432 user=postgres password=qwe123 dbname=dz14_2' 
PUBLICATION test2_pub WITH (copy_data = true);
```

2. Открываем на 3-ей виртуальной машине удаленный доступ. Создаем в кластере бд dz14_3.  Создаем там 2 пустых таблицы для подписок и сами подписки.
```
postgres=# \c dz14_3
dz14_3=# create table test1 (id integer, fio varchar);
dz14_3=# create table test2 (id integer, fio varchar);
dz14_3=# CREATE SUBSCRIPTION test2_sub3 
CONNECTION 'host=158.160.31.17 port=5432 user=postgres password=qwe123 dbname=dz14_2' 
PUBLICATION test2_pub WITH (copy_data = true);
NOTICE:  created replication slot "test2_sub3" on publisher
CREATE SUBSCRIPTION
dz14_3=# CREATE SUBSCRIPTION test1_sub3 
CONNECTION 'host=158.160.12.12 port=5432 user=postgres password=qwe123 dbname=dz14_1' 
PUBLICATION test1_pub WITH (copy_data = true);
NOTICE:  created replication slot "test1_sub3" on publisher
CREATE SUBSCRIPTION
```

3. **Горячее реплицирование для высокой доступности.**  

Открываем на 4 ВМ удаленный доступ. Останавливаем кластер и зачищаем старые файлы.
```
postgres@dz14-4:~$ pg_ctlcluster 15 main stop
postgres@dz14-4:~$ mv /var/lib/postgresql/15/main /var/lib/postgresql/15/main_bc
```
Меняем некоторые параметры на кластере 3-ей ВМ и рестартуем кластер.
```
postgres=# alter system set synchronous_commit=on;
postgres=# alter system set cluster_name='cluster_dz14_3';
postgres=# show synchronous_commit;
 synchronous_commit 
--------------------
 on
postgres=# show cluster_name;
  cluster_name  
----------------
 cluster_dz14_3
postgres=# exit
postgres@dz14-3:~$ pg_ctlcluster 15 main stop
postgres@dz14-3:~$ pg_ctlcluster 15 main start
```  
Копируем БД одновременно запуская процесс репликации. Проверяем, что параметр репликации включен. И задаем имя кластера.
```
postgres@dz14-4:~$ pg_basebackup -h 84.201.143.17 -p 5432 -R -D /var/lib/postgresql/15/main
postgres@dz14-4:~$ pg_ctlcluster 15 main start
postgres=# show hot_standby;
 hot_standby 
-------------
 on
postgres=# alter system set cluster_name='cluster_dz14_4';
postgres=# exit
postgres@dz14-4:~/15/main$ pg_ctlcluster 15 main stop
postgres@dz14-4:~/15/main$ pg_ctlcluster 15 main start
postgres@dz14-4:~/15/main$ psql
postgres=# show cluster_name;
  cluster_name  
----------------
 cluster_dz14_4
(1 row)
postgres=# \l
                                                 List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges   
-----------+----------+----------+-------------+-------------+------------+-----------------+-----------------------
 dz14_3    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | 
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | 
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres

postgres=# \c dz14_3
You are now connected to database "dz14_3" as user "postgres".
dz14_3=# \dt
         List of relations
 Schema | Name  | Type  |  Owner   
--------+-------+-------+----------
 public | test1 | table | postgres
 public | test2 | table | postgres
```
Меняем некоторые параметры на primary, чтобы репликация стала синхронной. И проверяем, что получилось.
```
postgres=# alter system set synchronous_standby_names='cluster_dz14_4';
postgres@dz14-3:~$ pg_ctlcluster 15 main stop
postgres@dz14-3:~$ pg_ctlcluster 15 main start
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@15-main
postgres@dz14-3:~$ psql
postgres=# SELECT * FROM pg_stat_replication \gx
-[ RECORD 1 ]----+------------------------------
pid              | 3058
usesysid         | 10
usename          | postgres
application_name | cluster_dz14_4
client_addr      | 130.193.43.85
client_hostname  | 
client_port      | 40664
backend_start    | 2023-04-03 14:33:55.612088+00
backend_xmin     | 
state            | streaming
sent_lsn         | 0/50002E0
write_lsn        | 0/50002E0
flush_lsn        | 0/50002E0
replay_lsn       | 0/50002E0
write_lag        | 
flush_lag        | 
replay_lag       | 
sync_priority    | 1
sync_state       | sync
reply_time       | 2023-04-03 14:36:15.878787+00
```






Доп команды:  
```
Для изменения ип в подписке:
dz14_2=# ALTER SUBSCRIPTION test1_sub CONNECTION 'host=158.160.31.70 port=5432 user=postgres password=qwe123 dbname=dz14_1';
```
