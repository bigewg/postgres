1. Создала виртуалку и поставила туда 14 постгрес.  
   Изменила параметры, касающиеся логирования блокировок.  
```
postgres=# ALTER SYSTEM SET log_lock_waits = on;
postgres=# ALTER SYSTEM SET deadlock_timeout='200ms';
locks=# show log_lock_waits;
 log_lock_waits 
----------------
 on

locks=# show deadlock_timeout;
 deadlock_timeout 
------------------
 200ms
```  
Открыла 2 сессии в БД в обеих сделала одновременный update 2 строк. После просмотра лога завершаем обе транзакции. 
```
locks=*# UPDATE accounts SET amount = amount + 100 WHERE acc_no = 1;
```
<details>
<summary>Содержание лога: </summary>  
 
tail -10 /var/log/postgresql/postgresql-14-main.log  
2023-03-10 13:15:45.359 UTC [51434] postgres@locks LOG:  process 51434 still waiting for ShareLock on transaction 736 after 200.229 ms  
2023-03-10 13:15:45.359 UTC [51434] postgres@locks DETAIL:  Process holding the lock: 51256. Wait queue: 51434.  
2023-03-10 13:15:45.359 UTC [51434] postgres@locks CONTEXT:  while updating tuple (0,1) in relation "accounts"  
2023-03-10 13:15:45.359 UTC [51434] postgres@locks STATEMENT:  UPDATE accounts SET amount = amount + 100 WHERE acc_no = 1;  
2023-03-10 13:15:55.851 UTC [51434] postgres@locks LOG:  process 51434 acquired ShareLock on transaction 736 after 10692.325 ms  
2023-03-10 13:15:55.851 UTC [51434] postgres@locks CONTEXT:  while updating tuple (0,1) in relation "accounts"  
2023-03-10 13:15:55.851 UTC [51434] postgres@locks STATEMENT:  UPDATE accounts SET amount = amount + 100 WHERE acc_no = 1;  
</details>  
 
 2. Создадим представление locks_v для упрощения просмтора блокировок.
<details>
<summary>Код вью: </summary>  
 
```   
CREATE VIEW locks_v AS  
SELECT pid,  
       locktype,  
       CASE locktype  
         WHEN 'relation' THEN relation::regclass::text  
         WHEN 'transactionid' THEN transactionid::text  
         WHEN 'tuple' THEN relation::regclass::text||':'||tuple::text  
       END AS lockid,  
       mode,  
       granted  
FROM pg_locks  
WHERE locktype in ('relation','transactionid','tuple')  
AND (locktype != 'relation' OR relation = 'accounts'::regclass);     
```  
</details>  
 
Открываем 3 сессии и в каждой делаем апдейт одной и той же строки.  
```
UPDATE accounts SET amount = amount + 100.00 WHERE acc_no = 1;
```  
   Получаем некоторую очередь за ресурсами.  
```
locks=*# SELECT pid, wait_event_type, wait_event, pg_blocking_pids(pid) 
FROM pg_stat_activity 
WHERE backend_type = 'client backend';
  pid  | wait_event_type |  wait_event   | pg_blocking_pids 
-------+-----------------+---------------+------------------
 53035 |                 |               | {}
 53032 | Lock            | transactionid | {53035}
 53046 | Lock            | tuple         | {53032}
```  

 Блокировки первой сессии:
 ```
 locks=*# SELECT txid_current(), pg_backend_pid();
 txid_current | pg_backend_pid 
--------------+----------------
          742 |          53035

locks=*# SELECT * FROM locks_v WHERE pid = 53035;
  pid  |   locktype    |  lockid  |       mode       | granted 
-------+---------------+----------+------------------+---------
 53035 | transactionid | 742      | ExclusiveLock    | t
 53035 | relation      | accounts | RowExclusiveLock | t
 ```  
 1-ая строка - это блокировка номера транзакции.  
 2-ая строка - блокировка таблицы accounts в режиме RowExclusiveLock.  
 
  Блокировки второй сессии:  
 ```
 locks=*# SELECT txid_current(), pg_backend_pid();
 txid_current | pg_backend_pid 
--------------+----------------
          743 |          53032

locks=*# SELECT * FROM locks_v WHERE pid =53032;
  pid  |   locktype    |   lockid   |       mode       | granted 
-------+---------------+------------+------------------+---------
 53032 | transactionid | 743        | ExclusiveLock    | t
 53032 | relation      | accounts   | RowExclusiveLock | t
 53032 | transactionid | 742        | ShareLock        | f
 53032 | tuple         | accounts:5 | ExclusiveLock    | t
 ```  
 1-ая и 2-ая строки аналогичны 1-ой сессии.  
 3-я строка - запрос блокировки номера первой транзакции. Он не одобрен (granted=f), т.к. первая транзакция еще не закомичена.  
 4-я строка - блокировка версии строки таблицы accounts.  
   
 **Везде написано, что мы повисаем на блокировке номера транзакции, удерживающей строку. Но я не очень понимаю, зачем нам блокировать этот номер. Нам нужна строка и логичнее блокировать именно ее...**  
  
   Блокировки третьей сессии:  
```
  pid  |   locktype    |   lockid   |       mode       | granted 
-------+---------------+------------+------------------+---------
 53046 | transactionid | 744        | ExclusiveLock    | t
 53046 | relation      | accounts   | RowExclusiveLock | t
 53046 | tuple         | accounts:5 | ExclusiveLock    | f
```   
1 и 2 аналогичны первым 2-м.  
3-я запрос блокировки версии строки таблицы accounts. Он не одобрен, т.к. блокировку на нее удерживает вторая сессия.  
  
