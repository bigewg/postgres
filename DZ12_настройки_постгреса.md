1. Создаем виртуалку (2CPU 4Gb) и устанавливаем постгрес 14.   
```
-- установка 15 ПГ
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
```

2. Инициализируем pgbench и запускаем его, чтобы было с чем сравнивать при настройке
```
postgres@dz12:~$ pgbench -i tune  
postgres@dz12:~$ pgbench -c 50 -j 2 -P 10 -T 60 tune  
...
tps = 573.114127 (without initial connection time)  
```  
<details>
<summary>Полный результат запуска pgbench до изменения настроек: </summary>  
  
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))  
starting vacuum...end.  
progress: 10.0 s, 476.8 tps, lat 102.722 ms stddev 119.512, 0 failed  
progress: 20.0 s, 582.2 tps, lat 86.712 ms stddev 96.738, 0 failed  
progress: 30.0 s, 661.8 tps, lat 75.303 ms stddev 69.026, 0 failed  
progress: 40.0 s, 583.8 tps, lat 85.287 ms stddev 85.399, 0 failed  
progress: 50.0 s, 507.1 tps, lat 98.089 ms stddev 100.989, 0 failed  
progress: 60.0 s, 626.0 tps, lat 80.594 ms stddev 94.691, 0 failed  
transaction type: <builtin: TPC-B (sort of)>  
scaling factor: 1  
query mode: simple  
number of clients: 50  
number of threads: 2  
maximum number of tries: 1  
duration: 60 s  
number of transactions actually processed: 34427  
number of failed transactions: 0 (0.000%)  
latency average = 87.124 ms  
latency stddev = 94.567 ms  
initial connection time = 61.261 ms  
tps = 573.114127 (without initial connection time)  
</details>

3. Запускаем pgtune 
https://pgtune.leopard.in.ua/#/

4. Меняем параметры, предложенные нам pgtune:  
```
postgres@dz12:~$ cat > /etc/postgresql/15/main/conf.d/my_param.conf
max_connections = 100         
shared_buffers = 1GB
effective_cache_size = 3GB
maintenance_work_mem = 256MB
checkpoint_timeout=15min  
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 4
effective_io_concurrency = 2
work_mem = 2621kB
min_wal_size = 1GB
max_wal_size = 4GB
synchronous_commit = on
```  
5. Перечитываем конфиг  
```
postgres@dz12:~$ pg_ctlcluster 15 main reload
```
6. Снова запускаем pgbench
```
postgres@dz12:~$ pgbench -c 50 -j 2 -P 10 -T 60 tune  
...
tps = 541.564283 (without initial connection time)    
```  

<details>
<summary>Полный промежуточный результат запуска pgbench : </summary>      

pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))  
starting vacuum...end.  
progress: 10.0 s, 442.1 tps, lat 111.158 ms stddev 117.314, 0 failed  
progress: 20.0 s, 603.1 tps, lat 83.191 ms stddev 84.345, 0 failed  
progress: 30.0 s, 497.2 tps, lat 98.266 ms stddev 103.417, 0 failed  
progress: 40.0 s, 567.9 tps, lat 90.144 ms stddev 110.658, 0 failed  
progress: 50.0 s, 644.1 tps, lat 77.306 ms stddev 71.212, 0 failed  
progress: 60.0 s, 504.3 tps, lat 97.274 ms stddev 112.105, 0 failed  
transaction type: <builtin: TPC-B (sort of)>  
scaling factor: 1  
query mode: simple  
number of clients: 50  
number of threads: 2  
maximum number of tries: 1  
duration: 60 s  
number of transactions actually processed: 32637  
number of failed transactions: 0 (0.000%)  
latency average = 92.066 ms  
latency stddev = 101.452 ms  
initial connection time = 66.741 ms  
tps = 541.564283 (without initial connection time)  
</details>  
  
7. Включим большие страницы
```
postgres@dz12:~$ pg_ctlcluster 15 main status
pg_ctl: server is running (PID: 2210)
/usr/lib/postgresql/15/bin/postgres "-D" "/var/lib/postgresql/15/main" "-c" "config_file=/etc/postgresql/15/main/postgresql.conf"
postgres@dz12:~$ grep ^VmPeak /proc/2210/status
VmPeak:	 1172300 kB
postgres@dz12:~$ psql
psql (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
Type "help" for help.

postgres=# select 1172300/1024/2;
 ?column? 
----------
      572
```
Добавили из под пользователя рут 600 страниц
```
root@dz12:/home/bigewg# sysctl -p
vm.nr_hugepages = 600
root@dz12:/home/bigewg# cat /proc/meminfo  | grep HugePages_
HugePages_Total:     600
HugePages_Free:      600
HugePages_Rsvd:        0
HugePages_Surp:        0
```
Добавили параметр  huge_pages = on в файл my_param.conf и рестартанули постгрес.
```
postgres@dz12:~$ pg_ctlcluster 15 main stop
postgres@dz12:~$ pg_ctlcluster 15 main start
postgres@dz12:~$ cat /proc/meminfo  | grep HugePages_
HugePages_Total:     600
HugePages_Free:      575
HugePages_Rsvd:      512
HugePages_Surp:        0
```  
  
8. Снова запускаем pgbench
```
postgres@dz12:~$ pgbench -c 50 -j 2 -P 10 -T 60 tune  
...
tps = 492.511667 (without initial connection time)    
```  

<details>
<summary>Полный промежуточный результат запуска pgbench : </summary>      

pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))  
starting vacuum...end.  
progress: 10.0 s, 566.5 tps, lat 86.878 ms stddev 82.121, 0 failed  
progress: 20.0 s, 447.6 tps, lat 111.409 ms stddev 111.726, 0 failed  
progress: 30.0 s, 452.4 tps, lat 111.191 ms stddev 143.647, 0 failed  
progress: 40.0 s, 423.8 tps, lat 117.813 ms stddev 128.037, 0 failed  
progress: 50.0 s, 557.0 tps, lat 89.721 ms stddev 98.695, 0 failed  
progress: 60.0 s, 509.4 tps, lat 98.234 ms stddev 104.496, 0 failed 
transaction type: <builtin: TPC-B (sort of)>  
scaling factor: 1  
query mode: simple  
number of clients: 50  
number of threads: 2  
maximum number of tries: 1  
duration: 60 s  
number of transactions actually processed: 29617  
number of failed transactions: 0 (0.000%)  
latency average = 101.325 ms  
latency stddev = 111.995 ms  
initial connection time = 58.648 ms  
tps = 492.511667 (without initial connection time)  
</details>  
  
9. Включаем асинхронный режим (synchronous_commit=off) 
10. Снова запускаем pgbench
```
postgres@dz12:~$ pgbench -c 50 -j 2 -P 10 -T 60 tune
...
tps = 2299.514863 (without initial connection time)
```  
<details>
<summary>Полный итоговый результат запуска pgbench: </summary>    
  
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))  
starting vacuum...end.  
progress: 10.0 s, 2289.4 tps, lat 21.566 ms stddev 19.693, 0 failed  
progress: 20.0 s, 2318.7 tps, lat 21.488 ms stddev 18.765, 0 failed  
progress: 30.0 s, 2311.5 tps, lat 21.572 ms stddev 19.417, 0 failed  
progress: 40.0 s, 2323.6 tps, lat 21.442 ms stddev 18.338, 0 failed  
progress: 50.0 s, 2293.6 tps, lat 21.698 ms stddev 19.473, 0 failed  
progress: 60.0 s, 2264.2 tps, lat 22.013 ms stddev 19.217, 0 failed  
transaction type: <builtin: TPC-B (sort of)>  
scaling factor: 1  
query mode: simple  
number of clients: 50  
number of threads: 2  
maximum number of tries: 1  
duration: 60 s  
number of transactions actually processed: 138059  
number of failed transactions: 0 (0.000%)  
latency average = 21.648 ms  
latency stddev = 19.194 ms  
initial connection time = 66.702 ms  
tps = 2299.514863 (without initial connection time)  

</details>  

11. Итог.  
Удалось достигнуть tps=2299. Основной выигрыш по производительности нам дало отключение синхронного режима (synchronous_commit=off). Но он делает работу бд недостаточно надежной - при аварийной остановке постгреса некоторые коммиты могут потеряться, если они не успели записаться на диск. Влияние остальных параметров при данных условиях(виртуалка и статичная нагрузка) не очень заметны.
<details>
<summary>Измененные параметры и их определение:</summary>   
  
```  
max_connections = 100  
  Максимальное колическво сессий(подключений) к БД.  
shared_buffers = 1GB  
  Размер общего кеша данных.  
effective_cache_size = 3GB  
  Подсказка для планировщика - сколько памяти можно потратить на выполнение плана.  
maintenance_work_mem = 256MB  
  Память для сессий, совершающих работу типа построения индексов, вакуума и тп.  
checkpoint_timeout=15min  
  Максимальное кол-во времени между 2-мя контрольными точками.  
checkpoint_completion_target = 0.9  
  Целевое время от checkpoint_timeout, за которое ожидается завершение контрольной точки.   
wal_buffers = 16MB  
  Размер памяти, который будет использоваться для буферизации данных журналирования, еще не сброшенных на диск.  
default_statistics_target = 100  
   Определяет размер части таблицы, которая будет анализироваться для получения статистики.  
random_page_cost = 4  
effective_io_concurrency = 2  
work_mem = 2621kB 
  Размер памяти сессии, который используется для сортировок и построения хештаблиц.  
min_wal_size = 1GB  
  "Зарезервированное" место под wal. Пока WAL занимает на диске меньше этого объёма, старые файлы WAL в контрольных точках всегда перерабатываются, а не удаляются.  
max_wal_size = 4GB  
  Максимальный размер, до которого может выраст WAL-журнал при выполнении автоматическтх контрольных точек.  
synchronous_commit = off  
  Режим записи данных закомиченных транзакций на диск, при котором допустимо не дожидаться окончания записи на диск. Небезопасен.  
```
</details>
  
12. sysbench
  Установка:
  ```
  curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.deb.sh | sudo bash
  sudo apt -y install sysbench
  ```
  Подготовка к запуску:  
  ```
postgres=# create database tune;
postgres=# CREATE USER tune WITH PASSWORD 'tune';
postgres=# GRANT ALL PRIVILEGES ON DATABASE tune to tune;
postgres=# \c tune
tune=# GRANT ALL ON SCHEMA public TO tune;
tune=# exit
  ```
  Запуск prepare:
  ```

  ```
